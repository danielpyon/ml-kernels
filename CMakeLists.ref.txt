cmake_minimum_required(VERSION 3.23.1)

project(flashinfer-rocm LANGUAGES CXX)

# gtest
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
include(FetchContent)
FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/refs/tags/v1.14.0.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

set(project_name test)

cmake_minimum_required(VERSION 3.21 FATAL_ERROR)
project(${project_name} LANGUAGES CXX)

set(GPU_RUNTIME "HIP" CACHE STRING "Switches between HIP and CUDA")
set(GPU_RUNTIMES "HIP" "CUDA")
set_property(CACHE GPU_RUNTIME PROPERTY STRINGS ${GPU_RUNTIMES})

if(NOT "${GPU_RUNTIME}" IN_LIST GPU_RUNTIMES)
    message(FATAL_ERROR "Only the following values are accepted for GPU_RUNTIME: ${GPU_RUNTIMES}")
endif()

enable_language(${GPU_RUNTIME})
set(CMAKE_${GPU_RUNTIME}_STANDARD 17)
set(CMAKE_${GPU_RUNTIME}_EXTENSIONS OFF)
set(CMAKE_${GPU_RUNTIME}_STANDARD_REQUIRED ON)

if(NOT CMAKE_PREFIX_PATH)
    set(CMAKE_PREFIX_PATH "/opt/rocm")
endif()

find_package(hipcub REQUIRED)

enable_testing()
add_executable(${project_name} test.cu sampling.cu norm.cu) # softmax.cu reduction.cu scan.cu)
add_test(${project_name} ${project_name})

target_link_libraries(${project_name}
    PRIVATE
    gtest
    gtest_main
    hip::hipcub
)

include(GoogleTest)
gtest_discover_tests(${project_name})

target_include_directories(${project_name}
    PRIVATE
    "../../../Common"
)
set_source_files_properties(main.hip PROPERTIES LANGUAGE ${GPU_RUNTIME})
if(WIN32)
    target_compile_definitions(${project_name} PRIVATE WIN32)
endif()

install(TARGETS ${project_name})
